<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tissa Bake House Label Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* FONTS */
        @font-face {
            font-family: 'Impact';
            src: local('Impact'), local('Arial Narrow Bold'), local('sans-serif');
        }

        /* MASTER DESIGN - NATIVE PRINT SIZE 
           Width: 67mm
           Height: 40mm
        */
        .label-design {
            width: 67mm;
            height: 40mm;
            border: 1px solid #ddd; /* Light border for screen view */
            background: white;
            color: black;
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* PREVIEW SCALING IN RIGHT SIDEBAR */
        #preview-container {
            width: 100%;
            height: 100%; /* Fill the container */
            min-height: 250px; /* Ensure visibility on mobile */
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f3f4f6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #master-label {
            /* RESPONSIVE SCALING */
            transform: scale(1.8); 
            transform-origin: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        /* Optimization for Tablet */
        @media (max-width: 1024px) {
            #master-label { transform: scale(1.4); }
        }

        /* Optimization for Mobile */
        @media (max-width: 640px) {
            #master-label { transform: scale(0.85); }
        }

        /* HEADER (Yellow) */
        .header-section {
            height: 15mm;
            background-color: #ffe500;
            border-bottom: 0.5mm solid black;
            position: relative;
            flex-shrink: 0;
            padding-top: 2mm;
        }

        /* BODY */
        .body-section {
            height: 25mm;
            display: flex;
            flex-direction: row;
        }

        .col-left { width: 26mm; border-right: 0.5mm solid black; display: flex; flex-direction: column; }
        .col-right { width: 41mm; display: flex; flex-direction: column; }
        .row-compact { border-bottom: 0.4mm solid black; display: flex; align-items: center; }

        .txt-sinhala { font-family: 'Noto Sans Sinhala', sans-serif; }
        .txt-tamil { font-family: 'Noto Sans Tamil', sans-serif; } 
        .txt-impact { font-family: 'Impact', sans-serif; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        .product-item:hover { background-color: #eff6ff; cursor: pointer; border-color: #3b82f6; }
        .product-item.active { background-color: #dbeafe; border-color: #2563eb; border-left-width: 4px; }

        /* PRINT SETTINGS */
        @media print {
            @page {
                size: A4;
                margin: 0 !important; /* RESET BROWSER DEFAULTS */
            }
            html, body { 
                margin: 0 !important; 
                padding: 0 !important; 
                background: white; 
                width: 210mm;
                height: 297mm;
            }
            .no-print { display: none !important; }

            /* Grid Layout Class - Applied to each chunk of labels */
            .print-page-grid {
                display: grid;
                grid-template-columns: repeat(3, 67mm);
                grid-auto-rows: 40mm; 
                justify-content: center;
                gap: 0;
                width: 100%;
                
                /* MANUAL PADDING FOR CENTERING */
                padding-top: 8.5mm; 
            }

            /* The Container for all print content */
            #print-area {
                display: block !important;
                width: 100%;
            }

            /* FORCE PAGE BREAK CLASS */
            .page-break-spacer {
                display: block;
                height: 0;
                page-break-after: always;
                break-after: page; 
                width: 100%;
                border: none;
            }

            .sticker-slot {
                width: 67mm;
                height: 40mm;
                box-sizing: border-box;
                position: relative;
                overflow: hidden;
            }

            .label-design {
                border: none !important;
                transform: none !important;
                margin: 0 !important;
                box-shadow: none !important;
            }

            .dashed-border { outline: 1px dashed #999; z-index: 10; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        #print-area { display: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col min-h-screen md:h-screen md:overflow-hidden">

    <div class="no-print bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-10 sticky top-0 md:relative">
        <div>
            <h1 class="text-lg md:text-xl font-bold text-red-700">Tissa Bake House</h1>
            <p class="text-[10px] md:text-xs text-gray-500">Label Generator V2.5</p>
        </div>
        <div class="flex gap-2">
            <button onclick="undo()" id="btn-undo" disabled class="bg-gray-300 text-white px-2 md:px-3 py-1 rounded shadow text-xs md:text-sm font-bold flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-400 transition-colors">
                <span>‚Ü©Ô∏è</span> <span class="hidden md:inline">Undo</span>
            </button>
            <button onclick="redo()" id="btn-redo" disabled class="bg-gray-300 text-white px-2 md:px-3 py-1 rounded shadow text-xs md:text-sm font-bold flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-400 transition-colors">
                <span>‚Ü™Ô∏è</span> <span class="hidden md:inline">Redo</span>
            </button>
        </div>
    </div>

    <div class="no-print flex-grow grid grid-cols-12 gap-0 overflow-y-auto md:overflow-hidden">
        
        <div class="col-span-12 md:col-span-3 bg-white border-r border-gray-200 flex flex-col h-auto md:h-full border-b md:border-b-0 order-1">
            <div class="p-4 border-b bg-gray-50">
                <label class="text-xs font-bold uppercase text-gray-500 mb-1 block">Search Products</label>
                <input type="text" id="search-input" placeholder="Type to search..." class="w-full border border-gray-300 rounded p-2 text-base md:text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div id="product-list-container" class="flex-grow overflow-y-auto custom-scroll p-2 space-y-1 max-h-[200px] md:max-h-full"></div>
            <div class="p-3 border-t bg-gray-50 text-center flex flex-col gap-2">
                <button onclick="addNewProduct()" class="w-full bg-blue-100 text-blue-700 hover:bg-blue-200 font-bold py-2 rounded text-sm">+ Create New Product</button>
                
                <div class="mt-4 pt-3 border-t border-gray-200 text-center">
                    <p class="text-xs text-slate-400 mb-0.5">Designed & Developed by</p>
                    <p class="text-sm font-bold text-slate-700 leading-none">Sujith Waruna</p>
                    <p class="text-xs text-slate-500 font-mono mt-1 tracking-wider">+94 77 940 7127</p>
                </div>
            </div>
        </div>

        <div class="col-span-12 md:col-span-5 bg-gray-50 flex flex-col h-auto md:h-full overflow-y-auto custom-scroll p-4 md:p-6 order-2">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Edit Details</h2>
            
            <div class="grid grid-cols-1 gap-4 mb-6">
                <div class="grid grid-cols-2 gap-3">
                     <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">English Name</label>
                        <input id="in-english" class="w-full p-2 border rounded font-bold text-red-700 text-base md:text-sm">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Sinhala Name</label>
                        <input id="in-sinhala" class="w-full p-2 border rounded text-base md:text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 bg-white p-3 rounded border shadow-sm">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">MFD Date</label>
                        <input id="in-mfd" class="w-full p-2 border rounded text-base md:text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">EXP Date</label>
                        <input id="in-exp" class="w-full p-2 border rounded text-base md:text-sm">
                    </div>
                    <div class="col-span-2 flex items-end gap-2">
                        <div class="flex-grow">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Batch No</label>
                            <input id="in-batch" class="w-full p-2 border rounded font-mono text-base md:text-sm">
                        </div>
                        <button onclick="incrementBatch()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded font-bold" title="Auto Increment Batch">+</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 bg-white p-3 rounded border shadow-sm">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Price</label>
                        <input id="in-price" class="w-full p-2 border rounded font-bold text-lg text-base md:text-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Weight / Qty</label>
                        <input id="in-weight" class="w-full p-2 border rounded text-base md:text-sm">
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mt-2">
                    <label class="block text-xs font-bold text-blue-800 uppercase mb-1">Quantity to Print</label>
                    <div class="flex gap-2 mb-3">
                        <input type="number" id="in-count" value="21" class="w-24 p-2 border border-blue-300 rounded font-bold text-center text-lg text-base md:text-lg">
                        <button onclick="addToQueue()" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded shadow-sm flex items-center justify-center gap-2">
                            <span>‚¨áÔ∏è</span> Add to Queue
                        </button>
                    </div>
                    <div class="flex justify-center">
                        <button onclick="addPageBreak()" class="text-xs font-bold text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded border border-blue-200 flex items-center gap-1 transition-all">
                            <span>üìÑ</span> Insert Page Break (Start New Sheet)
                        </button>
                    </div>
                </div>

                <div class="flex gap-2 mt-2">
                    <button onclick="saveCurrentAsDefault()" class="flex-1 bg-green-100 text-green-700 hover:bg-green-200 py-2 rounded text-sm font-bold">Update Saved Data</button>
                    <button onclick="deleteCurrentProduct()" class="flex-1 bg-red-100 text-red-700 hover:bg-red-200 py-2 rounded text-sm font-bold">Delete Product</button>
                </div>
            </div>
        </div>

        <div class="col-span-12 md:col-span-4 bg-white border-l border-gray-200 flex flex-col h-auto md:h-full order-3">
            <div class="p-4 border-b h-[300px] md:h-[350px] flex-shrink-0 bg-gray-50 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">Live Preview</h3>
                    <div class="flex items-center gap-2">
                         <input type="checkbox" id="show-guides" class="w-4 h-4" checked>
                         <label for="show-guides" class="text-xs text-gray-500">Borders</label>
                    </div>
                </div>
                <div id="preview-container">
                    <div id="master-label" class="label-design">
                        <div class="header-section flex flex-col items-center justify-start">
                            <div class="absolute bottom-0 left-0 w-full h-[6mm] overflow-hidden z-0">
                                 <svg viewBox="0 0 100 20" preserveAspectRatio="none" class="w-full h-full">
                                    <path d="M0,20 Q50,0 100,20 Z" fill="#c62828" />
                                </svg>
                            </div>
                            <div class="relative z-10 text-center leading-none w-full">
                                <div class="txt-sinhala text-[#c62828] font-bold text-[15pt] drop-shadow-sm whitespace-nowrap">
                                    ‡∂≠‡∑í‡∑É‡∑ä‡∑É ‡∂∂‡∑ö‡∂ö‡∑ä ‡∑Ñ‡∑Ä‡∑î‡∑É‡∑ä
                                </div>
                                <div class="flex items-baseline justify-center gap-2 mt-[2.1px]">
                                    <span class="font-bold text-[#5d4037] text-[6.5pt] uppercase tracking-tighter" style="font-family: 'Arial Narrow'">TISSA BAKE HOUSE</span>
                                    <span class="font-bold text-[#5d4037] text-[6pt] txt-tamil">‡Æ§‡Æø‡Æ∏‡Øç‡Æ∏ ‡Æ™‡Øá‡Æï‡Øç ‡Æπ‡Æµ‡ØÅ‡Æ∏‡Øç</span>
                                </div>
                                <div class="text-[3pt] font-bold text-black mt-[1px] leading-[3.6pt] max-w-[98%] mx-auto text-center px-1">
                                    <span id="out-ing-en" class="block">Ing: Wheat flour, margarine, salt, sugar, yeast</span>
                                    <span id="out-ing-si" class="block txt-sinhala">‡∂Ö‡∂©‡∂Ç‡∂ú‡∑î ‡∂Ø‡∑ä‚Äç‡∂ª‡∑Ä‡∑ä‚Äç‡∂∫: ‡∂≠‡∑í‡∂ª‡∑í‡∂ü‡∑î ‡∂¥‡∑í‡∂ß‡∑í, ‡∂∏‡∑è‡∂ú‡∂ª‡∑í‡∂±‡∑ä, ‡∂Ω‡∑î‡∂´‡∑î, ‡∑É‡∑ì‡∂±‡∑í, ‡∂ä‡∑É‡∑ä‡∂ß‡∑ä</span>
                                    <span id="out-ing-ta" class="block txt-tamil">‡Æâ‡Æ≥‡Øç‡Æ≥‡Æü‡Æô‡Øç‡Æï‡Æø‡ÆØ‡Æµ‡Øà: ‡Æï‡Øã‡Æ§‡ØÅ‡ÆÆ‡Øà ‡ÆÆ‡Ææ, ‡ÆÆ‡Ææ‡Æú‡Æ∞‡Æø‡Æ©‡Øç, ‡Æâ‡Æ™‡Øç‡Æ™‡ØÅ, ‡Æö‡ØÄ‡Æ©‡Æø, ‡Æà‡Æ∏‡Øç‡Æü‡Øç</span>
                                </div>
                            </div>
                            <div class="absolute right-[0.5mm] top-[2mm] rotate-180" style="writing-mode: vertical-rl;">
                                <span class="text-[5.5pt] font-bold">Reg: 12065</span>
                            </div>
                        </div>
                        <div class="body-section">
                            <div class="col-left">
                                <div class="row-compact h-[8mm]">
                                    <div class="w-[9mm] border-right border-black h-full flex flex-col justify-center px-[0.5mm] border-r-[0.5mm] border-black text-center">
                                        <span class="text-[4.5pt] font-bold leading-none block">MFD</span>
                                        <span class="text-[4pt] font-bold leading-none block txt-sinhala my-[0.5px]">‡∂±‡∑í‡∑Ç‡∑ä.‡∂Ø‡∑í‡∂±‡∂∫</span>
                                        <span class="text-[3.5pt] font-bold leading-none block txt-tamil">‡Æâ‡Æ±‡Øç‡Æ™‡Æ§‡Øç‡Æ§‡Æø</span>
                                    </div>
                                    <div id="out-mfd" class="flex-1 text-center font-bold text-[8pt]"></div>
                                </div>
                                <div class="row-compact h-[8mm]">
                                    <div class="w-[9mm] border-right border-black h-full flex flex-col justify-center px-[0.5mm] border-r-[0.5mm] border-black text-center">
                                        <span class="text-[4.5pt] font-bold leading-none block">EXP</span>
                                        <span class="text-[4pt] font-bold leading-none block txt-sinhala my-[0.5px]">‡∂ö‡∂Ω‡∑ä.‡∂â‡∂ö‡∑î‡∂≠‡∑ä</span>
                                        <span class="text-[3.5pt] font-bold leading-none block txt-tamil">‡Æï‡Ææ‡Æ≤‡Ææ‡Æµ‡Æ§‡Æø</span>
                                    </div>
                                    <div id="out-exp" class="flex-1 text-center font-bold text-[8pt]"></div>
                                </div>
                                <div class="flex-grow flex items-center">
                                    <div class="w-[9mm] h-full flex flex-col justify-center px-[0.5mm] border-r-[0.5mm] border-black text-center">
                                        <span class="text-[4pt] font-bold leading-none block">MAX PRICE</span>
                                        <span class="text-[3.5pt] font-bold leading-none block txt-sinhala my-[0.5px]">‡∂ã‡∂¥‡∂ª‡∑í‡∂∏ ‡∂∏‡∑í‡∂Ω</span>
                                        <span class="text-[3pt] font-bold leading-none block txt-tamil">‡Æï‡ØÇ‡Æü‡Æø‡ÆØ ‡Æµ‡Æø‡Æ≤‡Øà</span>
                                    </div>
                                    <div id="out-price" class="flex-1 text-center font-bold text-[15pt]"></div>
                                </div>
                            </div>
                            <div class="col-right">
                                <div class="h-[12mm] border-bottom border-b-[0.5mm] border-black flex flex-col items-center justify-center text-center px-1 overflow-hidden">
                                    <span id="out-sinhala" class="txt-sinhala font-bold text-[12pt] leading-none mb-[5px]"></span>
                                    <span id="out-english" class="txt-impact text-[#c62828] text-[13pt] uppercase leading-[0.7] w-full" style="white-space: nowrap;"></span>
                                </div>
                                <div class="h-[7mm] border-b-[0.5mm] border-black flex">
                                    <div class="w-[50%] border-r-[0.5mm] border-black flex items-center justify-between px-[1mm]">
                                        <div class="flex flex-col text-[4.1pt] font-bold leading-tight">
                                            <span id="lbl-weight-en">Weight</span>
                                            <span id="lbl-weight-si" class="txt-sinhala">‡∂∂‡∂ª</span>
                                            <span id="lbl-weight-ta" class="txt-tamil">‡Æ®‡Æø‡Æ±‡Øà</span>
                                        </div>
                                        <div class="text-right">
                                            <span id="out-weight" class="text-[8pt] font-bold block leading-none"></span>
                                            <span id="out-tol" class="text-[3pt] block mt-[0.5mm]">5g¬±</span>
                                        </div>
                                    </div>
                                    <div class="w-[50%] flex items-center justify-between px-[1mm]">
                                        <div class="flex flex-col text-[4.1pt] font-bold leading-tight text-right">
                                            <span>Batch</span>
                                            <span class="txt-sinhala">‡∂ö‡∑è‡∂´‡∑ä‡∂©‡∂∫</span>
                                        </div>
                                        <span id="out-batch" class="text-[8pt] font-bold"></span>
                                    </div>
                                </div>
                                <div class="flex-grow bg-black text-white flex flex-col justify-center items-center text-center leading-[4.1pt]">
                                    <span class="text-[3pt] font-bold txt-sinhala">‡∂∏‡∑î‡∂ª‡∑î‡∂≠‡∂Ω‡∑è‡∑Ä ‡∂¥‡∑è‡∂ª, ‡∂Ö‡∂Ç‡∂ö 119, ‡∂ö‡∂∏‡∑ä‡∂∂‡∑í‡∂∫‡∂©‡∑í‡∂∫, ‡∂∏‡∑Ñ‡∂±‡∑î‡∑Ä‡∂ª</span>
                                    <span class="text-[3pt] font-bold my-[0.5px]">Muruthalawa Rd, 119, Kambiadiya, Kandy</span>
                                    <span class="text-[3pt] font-bold txt-tamil">‡ÆÆ‡ØÅ‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡Æ≤‡Ææ‡Æµ ‡Æµ‡ØÄ‡Æ§‡Æø, ‡Æá‡Æ≤. 119, ‡Æï‡ÆÆ‡Øç‡Æ™‡Æø‡ÆÖ‡Æü‡Æø‡ÆØ, ‡Æï‡Æ£‡Øç‡Æü‡Æø</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-grow flex flex-col overflow-hidden">
                <div class="p-3 bg-gray-100 border-b flex justify-between items-center">
                    <h3 class="font-bold text-gray-700">Print Queue</h3>
                    <span id="total-stickers" class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded">Total: 0</span>
                </div>
                <div id="queue-list" class="flex-grow overflow-y-auto custom-scroll p-0 max-h-[250px] md:max-h-full"></div>
                <div class="p-4 border-t bg-white mb-8 md:mb-0">
                    <button onclick="generatePrintSheet()" class="w-full bg-blue-800 hover:bg-blue-900 text-white font-bold text-lg py-4 rounded-lg shadow flex justify-center items-center gap-2">
                        <span>üñ®Ô∏è</span> GENERATE PDF
                    </button>
                    <button onclick="clearQueue()" class="w-full text-red-500 text-xs mt-2 underline">Clear Queue</button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        // DATA & STATE
        let products = [
            { id: 'p1', name: 'CUP CAKE (‡∑É‡∑ä‡∂¥‡∂±‡∑ä‡∂†‡∑í)', sinhala: '‡∑É‡∑ä‡∂¥‡∂±‡∑ä‡∂†‡∑í', english: 'CUP CAKE', price: '600/-', weight: '10', batch: '222', measure: 'pieces' },
            { id: 'p2', name: 'FAMILY BUN (‡∑Ü‡∑ê‡∂∏‡∑í‡∂Ω‡∑í ‡∂∂‡∂±‡∑ä)', sinhala: '‡∑Ü‡∑ê‡∂∏‡∑í‡∂Ω‡∑í ‡∂∂‡∂±‡∑ä', english: 'FAMILY BUN', price: '110/-', weight: '120g', batch: '221', measure: 'weight' },
            { id: 'p3', name: 'SWEET BREAD (‡∑É‡∑ä‡∑Ä‡∑ì‡∂ß‡∑ä ‡∂¥‡∑è‡∂±‡∑ä)', sinhala: '‡∑É‡∑ä‡∑Ä‡∑ì‡∂ß‡∑ä ‡∂¥‡∑è‡∂±‡∑ä', english: 'SWEET BREAD', price: '120/-', weight: '175g', batch: '224', measure: 'weight' },
            { id: 'p4', name: 'CREAM BUN (‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∏‡∑ä ‡∂∂‡∂±‡∑ä)', sinhala: '‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∏‡∑ä ‡∂∂‡∂±‡∑ä', english: 'CREAM BUN', price: '50/-', weight: '60g', batch: '225', measure: 'weight' },
            { id: 'p5', name: 'ADA CAKE (‡∂Ö‡∂© ‡∂ö‡∑ö‡∂ö‡∑ä)', sinhala: '‡∂Ö‡∂© ‡∂ö‡∑ö‡∂ö‡∑ä', english: 'ADA CAKE', price: '400/-', weight: '10', batch: '222', measure: 'pieces' },
            { id: 'p6', name: 'BISCUITS (‡∑Ä‡∑í‡∑É‡∑ä‡∂ö‡∑ù‡∂≠‡∑î)', sinhala: '‡∑Ä‡∑í‡∑É‡∑ä‡∂ö‡∑ù‡∂≠‡∑î', english: 'BISCUITS', price: '90/-', weight: '90g', batch: '222', measure: 'weight' },
            { id: 'p7', name: 'VAPERS CAKE (‡∑Ä‡∑ö‡∂¥‡∑É‡∑ä ‡∂ö‡∑ö‡∂ö‡∑ä)', sinhala: '‡∑Ä‡∑ö‡∂¥‡∑É‡∑ä ‡∂ö‡∑ö‡∂ö‡∑ä', english: 'VAPERS CAKE', price: '700/-', weight: '10', batch: '222', measure: 'pieces' },
            { id: 'p8', name: 'BABY RUSK (‡∂∂‡∑ö‡∂∂‡∑í ‡∂ª‡∑É‡∑ä‡∂ö‡∑ä)', sinhala: '‡∂∂‡∑ö‡∂∂‡∑í ‡∂ª‡∑É‡∑ä‡∂ö‡∑ä', english: 'BABY RASK', price: '90/-', weight: '90g', batch: '220', measure: 'weight' },
            { id: 'p10', name: 'FAMILY CHOCOLATE CREAM BUN (‡∑Ü‡∑ê‡∂∏‡∑í‡∂Ω‡∑í ‡∂†‡∑ú‡∂ö‡∑ä‡∂Ω‡∂ß‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∏‡∑ä ‡∂∂‡∂±‡∑ä)', sinhala: '‡∑Ü‡∑ê‡∂∏‡∑í‡∂Ω‡∑í ‡∂†‡∑ú‡∂ö‡∑ä‡∂Ω‡∂ß‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∏‡∑ä ‡∂∂‡∂±‡∑ä', english: 'FAMILY CHOCOLATE CREAM BUN', price: '140/-', weight: '160g', batch: '224', measure: 'weight' },
        ];
        
        const savedProducts = localStorage.getItem('tissa_products_db_v1');
        if (savedProducts) { try { products = JSON.parse(savedProducts); } catch(e) {} }

        let state = { sinhala: '‡∑É‡∑ä‡∂¥‡∂±‡∑ä‡∂†‡∑í', english: 'CUP CAKE', mfd: '2023.02.01', exp: '2023.12.05', price: '600/-', weight: '10', batch: '222', type: 'pieces', currentId: 'p1' };
        let printQueue = [];
        const historyStack = [];
        let historyStep = -1;
        let debounceTimer;

        // ELEMENTS
        const els = {
            sName: document.getElementById('in-sinhala'), eName: document.getElementById('in-english'),
            mfd: document.getElementById('in-mfd'), exp: document.getElementById('in-exp'),
            price: document.getElementById('in-price'), weight: document.getElementById('in-weight'),
            batch: document.getElementById('in-batch'), count: document.getElementById('in-count'),
            guides: document.getElementById('show-guides'),
            o_sName: document.getElementById('out-sinhala'), o_eName: document.getElementById('out-english'),
            o_mfd: document.getElementById('out-mfd'), o_exp: document.getElementById('out-exp'),
            o_price: document.getElementById('out-price'), o_weight: document.getElementById('out-weight'),
            o_batch: document.getElementById('out-batch'), o_tol: document.getElementById('out-tol'),
            o_ing_en: document.getElementById('out-ing-en'), o_ing_si: document.getElementById('out-ing-si'), o_ing_ta: document.getElementById('out-ing-ta'),
            lbl_en: document.getElementById('lbl-weight-en'), lbl_si: document.getElementById('lbl-weight-si'), lbl_ta: document.getElementById('lbl-weight-ta')
        };

        // FUNCTIONS
        function saveHistory() {
            if (historyStep < historyStack.length - 1) historyStack.splice(historyStep + 1);
            historyStack.push(JSON.parse(JSON.stringify(state)));
            historyStep++;
            updateUndoRedoButtons();
        }
        function undo() { if (historyStep > 0) { historyStep--; restoreState(historyStack[historyStep]); updateUndoRedoButtons(); } }
        function redo() { if (historyStep < historyStack.length - 1) { historyStep++; restoreState(historyStack[historyStep]); updateUndoRedoButtons(); } }
        function restoreState(s) { state = JSON.parse(JSON.stringify(s)); syncInputs(); render(); highlightSelectedProduct(); }
        function updateUndoRedoButtons() {
            const btnUndo = document.getElementById('btn-undo'), btnRedo = document.getElementById('btn-redo');
            btnUndo.disabled = historyStep <= 0; btnRedo.disabled = historyStep >= historyStack.length - 1;
            btnUndo.className = `text-white px-3 py-1 rounded shadow text-xs md:text-sm font-bold flex items-center gap-1 transition-colors ${btnUndo.disabled ? 'bg-gray-300 cursor-not-allowed opacity-50' : 'bg-purple-600'}`;
            btnRedo.className = `text-white px-3 py-1 rounded shadow text-xs md:text-sm font-bold flex items-center gap-1 transition-colors ${btnRedo.disabled ? 'bg-gray-300 cursor-not-allowed opacity-50' : 'bg-purple-600'}`;
        }
        function triggerDebouncedSave() { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => saveHistory(), 500); }

        function render() {
            if (state.currentId === 'p10') {
                els.o_ing_en.innerText = "Ing: Wheat flour, margarine, Coco powder, salt, sugar, yeast";
                els.o_ing_si.innerText = "‡∂Ö‡∂©‡∂Ç‡∂ú‡∑î ‡∂Ø‡∑ä‚Äç‡∂ª‡∑Ä‡∑ä‚Äç‡∂∫: ‡∂≠‡∑í‡∂ª‡∑í‡∂ü‡∑î ‡∂¥‡∑í‡∂ß‡∑í, ‡∂ö‡∑ú‡∂ö‡∑ù ‡∂¥‡∑í‡∂ß‡∑í, ‡∂∏‡∑è‡∂ú‡∂ª‡∑í‡∂±‡∑ä, ‡∂Ω‡∑î‡∂´‡∑î, ‡∑É‡∑ì‡∂±‡∑í, ‡∂ä‡∑É‡∑ä‡∂ß‡∑ä";
                els.o_ing_ta.innerText = "‡Æâ‡Æ≥‡Øç‡Æ≥‡Æü‡Æô‡Øç‡Æï‡Æø‡ÆØ‡Æµ‡Øà: ‡Æï‡Øã‡Æ§‡ØÅ‡ÆÆ‡Øà ‡ÆÆ‡Ææ, ‡Æï‡Øä‡Æï‡Øç‡Æï‡Øã ‡Æ§‡ØÇ‡Æ≥‡Øç, ‡ÆÆ‡Ææ‡Æú‡Æ∞‡Æø‡Æ©‡Øç, ‡Æâ‡Æ™‡Øç‡Æ™‡ØÅ, ‡Æö‡ØÄ‡Æ©‡Æø, ‡Æà‡Æ∏‡Øç‡Æü‡Øç";
            } else if (state.currentId === 'p5') {
                els.o_ing_en.innerText = "Ing: Wheat flour, margarine, baking powder, milk powder, eggs, essence";
                els.o_ing_si.innerText = "‡∂Ö‡∂©‡∂Ç‡∂ú‡∑î ‡∂Ø‡∑ä‚Äç‡∂ª‡∑Ä‡∑ä‚Äç‡∂∫: ‡∂≠‡∑í‡∂ª‡∑í‡∂ü‡∑î ‡∂¥‡∑í‡∂ß‡∑í, ‡∂∏‡∑è‡∂ú‡∂ª‡∑í‡∂±‡∑ä, ‡∂∂‡∑ö‡∂ö‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∑î‡∂©‡∂ª‡∑ä, ‡∂∂‡∑í‡∂≠‡∑ä‡∂≠‡∂ª, ‡∂ö‡∑í‡∂ª‡∑í‡∂¥‡∑í‡∂ß‡∑í, ‡∂ë‡∑É‡∂±‡∑ä‡∑É‡∑ä";
                els.o_ing_ta.innerText = "‡Æâ‡Æ≥‡Øç‡Æ≥‡Æü‡Æô‡Øç‡Æï‡Æø‡ÆØ‡Æµ‡Øà: ‡Æï‡Øã‡Æ§‡ØÅ‡ÆÆ‡Øà ‡ÆÆ‡Ææ, ‡ÆÆ‡Ææ‡Æï‡Æ∞‡Æø‡Æ©‡Øç, ‡Æ™‡Øá‡Æï‡Æø‡Æô‡Øç ‡Æ™‡Æµ‡ØÅ‡Æü‡Æ∞‡Øç, ‡ÆÆ‡ØÅ‡Æü‡Øç‡Æü‡Øà, ‡Æ™‡Ææ‡Æ≤‡Øç ‡ÆÆ‡Ææ, ‡Æé‡Æö‡Æ©‡Øç‡Æ∏‡Øç";
            } else {
                els.o_ing_en.innerText = "Ing: Wheat flour, margarine, salt, sugar, yeast";
                els.o_ing_si.innerText = "‡∂Ö‡∂©‡∂Ç‡∂ú‡∑î ‡∂Ø‡∑ä‚Äç‡∂ª‡∑Ä‡∑ä‚Äç‡∂∫: ‡∂≠‡∑í‡∂ª‡∑í‡∂ü‡∑î ‡∂¥‡∑í‡∂ß‡∑í, ‡∂∏‡∑è‡∂ú‡∂ª‡∑í‡∂±‡∑ä, ‡∂Ω‡∑î‡∂´‡∑î, ‡∑É‡∑ì‡∂±‡∑í, ‡∂ä‡∑É‡∑ä‡∂ß‡∑ä";
                els.o_ing_ta.innerText = "‡Æâ‡Æ≥‡Øç‡Æ≥‡Æü‡Æô‡Øç‡Æï‡Æø‡ÆØ‡Æµ‡Øà: ‡Æï‡Øã‡Æ§‡ØÅ‡ÆÆ‡Øà ‡ÆÆ‡Ææ, ‡ÆÆ‡Ææ‡Æú‡Æ∞‡Æø‡Æ©‡Øç, ‡Æâ‡Æ™‡Øç‡Æ™‡ØÅ, ‡Æö‡ØÄ‡Æ©‡Æø, ‡Æà‡Æ∏‡Øç‡Æü‡Øç";
            }

            els.o_sName.style.fontSize = state.sinhala.length > 20 ? "8.3pt" : "12pt";
            els.o_sName.innerText = state.sinhala;
            els.o_eName.innerText = state.english;
            els.o_mfd.innerText = state.mfd; els.o_exp.innerText = state.exp;
            els.o_price.innerText = state.price; els.o_weight.innerText = state.weight; els.o_batch.innerText = state.batch;

            if(state.type === 'pieces') {
                els.lbl_en.innerText = "Pieces"; els.lbl_si.innerText = "‡∂ö‡∑ê‡∂∂‡∂Ω‡∑í ‡∂ú‡∂´‡∂±"; els.lbl_ta.innerText = "‡Æé‡Æ£‡Øç‡Æ£‡Æø‡Æï‡Øç‡Æï‡Øà"; els.o_tol.style.display = 'none';
            } else {
                els.lbl_en.innerText = "Weight"; els.lbl_si.innerText = "‡∂∂‡∂ª"; els.lbl_ta.innerText = "‡Æ®‡Æø‡Æ±‡Øà"; els.o_tol.style.display = 'block';
            }

            if(state.english.length > 20) { els.o_eName.style.fontSize = "9pt"; els.o_eName.style.lineHeight = "0.85"; els.o_eName.style.whiteSpace = "normal"; }
            else if(state.english.length > 15) { els.o_eName.style.fontSize = "11pt"; els.o_eName.style.lineHeight = "0.9"; els.o_eName.style.whiteSpace = "normal"; }
            else if(state.english.length > 12) { els.o_eName.style.fontSize = "13pt"; els.o_eName.style.whiteSpace = "nowrap"; }
            else { els.o_eName.style.fontSize = "15pt"; els.o_eName.style.whiteSpace = "nowrap"; }
        }

        function renderProductList(filter = "") {
            const container = document.getElementById('product-list-container');
            container.innerHTML = "";
            products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase())).forEach(p => {
                const div = document.createElement('div');
                div.className = `product-item p-3 border border-gray-200 rounded mb-1 bg-white text-sm transition-all`;
                if(state.currentId === p.id) div.classList.add('active');
                div.innerHTML = `<div class="font-bold text-gray-800">${p.english}</div><div class="text-xs text-gray-500 flex justify-between"><span>${p.sinhala}</span><span class="bg-gray-100 px-1 rounded">${p.price}</span></div>`;
                div.onclick = () => selectProduct(p.id);
                container.appendChild(div);
            });
        }
        document.getElementById('search-input').addEventListener('input', (e) => renderProductList(e.target.value));

        function selectProduct(id) {
            const p = products.find(x => x.id === id);
            if(p) { state.currentId = p.id; state.sinhala = p.sinhala; state.english = p.english; state.price = p.price; state.weight = p.weight; state.batch = p.batch; state.type = p.measure || 'weight'; syncInputs(); render(); highlightSelectedProduct(); saveHistory(); }
        }
        function highlightSelectedProduct() { renderProductList(document.getElementById('search-input').value); }
        function syncInputs() { els.sName.value = state.sinhala; els.eName.value = state.english; els.price.value = state.price; els.weight.value = state.weight; els.batch.value = state.batch; els.mfd.value = state.mfd; els.exp.value = state.exp; }
        function incrementBatch() { let val = parseInt(state.batch); if(isNaN(val)) val = 0; state.batch = (val + 1).toString(); els.batch.value = state.batch; render(); triggerDebouncedSave(); }

        // QUEUE
        function addToQueue() {
            const qty = parseInt(els.count.value) || 0;
            if(qty <= 0) return alert("Quantity must be greater than 0");
            printQueue.push({ type: 'product', ...state, printCount: qty, uid: Date.now() });
            renderQueue();
        }
        function addPageBreak() { printQueue.push({ type: 'break', uid: Date.now() }); renderQueue(); }
        function removeFromQueue(uid) { printQueue = printQueue.filter(i => i.uid !== uid); renderQueue(); }
        function clearQueue() { if(confirm("Clear print queue?")) { printQueue = []; renderQueue(); } }

        function renderQueue() {
            const list = document.getElementById('queue-list'); list.innerHTML = ""; let total = 0;
            if(printQueue.length === 0) list.innerHTML = '<div class="text-center text-gray-400 mt-10 text-sm">Queue is empty.</div>';
            else {
                printQueue.forEach((item, idx) => {
                    const div = document.createElement('div');
                    if(item.type === 'break') {
                        div.className = "flex justify-between items-center bg-gray-200 p-2 border-b text-sm border-dashed border-gray-400";
                        div.innerHTML = `<div class="font-bold text-gray-600 text-xs w-full text-center tracking-widest">--- PAGE BREAK ---</div><button onclick="removeFromQueue(${item.uid})" class="text-red-500 font-bold px-2 rounded ml-2">√ó</button>`;
                    } else {
                        total += item.printCount;
                        div.className = "flex justify-between items-center bg-white p-2 border-b text-sm";
                        div.innerHTML = `<div class="flex items-center gap-2"><span class="font-bold text-gray-500 w-5">${idx+1}.</span><div><div class="font-bold truncate w-32">${item.english}</div><div class="text-xs text-gray-400">${item.batch}</div></div></div><div class="flex items-center gap-2"><span class="font-bold bg-blue-50 text-blue-700 px-2 rounded">x${item.printCount}</span><button onclick="removeFromQueue(${item.uid})" class="text-red-500 font-bold px-2 rounded">√ó</button></div>`;
                    }
                    list.appendChild(div);
                });
            }
            document.getElementById('total-stickers').innerText = "Total: " + total;
        }

        // LISTENERS & CRUD
        ['sName','eName','mfd','exp','price','weight','batch'].forEach(k => { els[k].addEventListener('input', e => { if(k=='sName') state.sinhala = e.target.value; if(k=='eName') state.english = e.target.value; if(k=='mfd') state.mfd = e.target.value; if(k=='exp') state.exp = e.target.value; if(k=='price') state.price = e.target.value; if(k=='weight') state.weight = e.target.value; if(k=='batch') state.batch = e.target.value; render(); triggerDebouncedSave(); }); });
        function saveProductsToStorage() { localStorage.setItem('tissa_products_db_v1', JSON.stringify(products)); }
        function addNewProduct() { const en = prompt("English Name:"); if(!en) return; const si = prompt("Sinhala Name:"); if(!si) return; const isP = confirm("Sold by Pieces?"); const newId = 'c_'+Date.now(); products.push({ id:newId, name:`${en} (${si})`, sinhala:si, english:en, price:'', weight:'', batch:'', measure:isP?'pieces':'weight' }); saveProductsToStorage(); renderProductList(); selectProduct(newId); }
        function deleteCurrentProduct() { if(confirm("Delete?")) { products = products.filter(p=>p.id!==state.currentId); saveProductsToStorage(); renderProductList(); if(products.length>0) selectProduct(products[0].id); } }
        function saveCurrentAsDefault() { const idx = products.findIndex(p=>p.id===state.currentId); if(idx>-1) { products[idx].sinhala=state.sinhala; products[idx].english=state.english; products[idx].price=state.price; products[idx].weight=state.weight; products[idx].batch=state.batch; products[idx].name=`${state.english} (${state.sinhala})`; saveProductsToStorage(); renderProductList(); alert("Saved"); } }

        // --- NEW PRINT LOGIC (Grid Chunks) ---
        function generatePrintSheet() {
            const area = document.getElementById('print-area');
            const master = document.getElementById('master-label');
            const guides = els.guides.checked;
            
            if(printQueue.length === 0) {
                if(confirm("Queue is empty. Print current selection (" + els.count.value + ")?")) addToQueue();
                else return;
            }
            
            area.innerHTML = '';
            
            // Function to create a new grid chunk
            function createNewGrid() {
                const grid = document.createElement('div');
                grid.className = 'print-page-grid';
                return grid;
            }

            let currentGrid = createNewGrid();
            area.appendChild(currentGrid); // Start with one grid

            printQueue.forEach(item => {
                if (item.type === 'break') {
                    // STOP Current Grid, Insert Break, Start New Grid
                    const breaker = document.createElement('div');
                    breaker.className = 'page-break-spacer';
                    area.appendChild(breaker);

                    currentGrid = createNewGrid(); // New Grid Container
                    area.appendChild(currentGrid);
                    return;
                }

                // ... [Logic to set item ingredients/fonts matches previous code] ...
                let ingEn, ingSi, ingTa;
                if (item.currentId === 'p10') { ingEn="Ing: Wheat flour, margarine, Coco powder, salt, sugar, yeast"; ingSi="‡∂Ö‡∂©‡∂Ç‡∂ú‡∑î ‡∂Ø‡∑ä‚Äç‡∂ª‡∑Ä‡∑ä‚Äç‡∂∫: ‡∂≠‡∑í‡∂ª‡∑í‡∂ü‡∑î ‡∂¥‡∑í‡∂ß‡∑í, ‡∂ö‡∑ú‡∂ö‡∑ù ‡∂¥‡∑í‡∂ß‡∑í, ‡∂∏‡∑è‡∂ú‡∂ª‡∑í‡∂±‡∑ä, ‡∂Ω‡∑î‡∂´‡∑î, ‡∑É‡∑ì‡∂±‡∑í, ‡∂ä‡∑É‡∑ä‡∂ß‡∑ä"; ingTa="‡Æâ‡Æ≥‡Øç‡Æ≥‡Æü‡Æô‡Øç‡Æï‡Æø‡ÆØ‡Æµ‡Øà: ‡Æï‡Øã‡Æ§‡ØÅ‡ÆÆ‡Øà ‡ÆÆ‡Ææ, ‡Æï‡Øä‡Æï‡Øç‡Æï‡Øã ‡Æ§‡ØÇ‡Æ≥‡Øç, ‡ÆÆ‡Ææ‡Æú‡Æ∞‡Æø‡Æ©‡Øç, ‡Æâ‡Æ™‡Øç‡Æ™‡ØÅ, ‡Æö‡ØÄ‡Æ©‡Æø, ‡Æà‡Æ∏‡Øç‡Æü‡Øç"; }
                else if (item.currentId === 'p5') { ingEn="Ing: Wheat flour, margarine, baking powder, milk powder, eggs, essence"; ingSi="‡∂Ö‡∂©‡∂Ç‡∂ú‡∑î ‡∂Ø‡∑ä‚Äç‡∂ª‡∑Ä‡∑ä‚Äç‡∂∫: ‡∂≠‡∑í‡∂ª‡∑í‡∂ü‡∑î ‡∂¥‡∑í‡∂ß‡∑í, ‡∂∏‡∑è‡∂ú‡∂ª‡∑í‡∂±‡∑ä, ‡∂∂‡∑ö‡∂ö‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∑î‡∂©‡∂ª‡∑ä, ‡∂∂‡∑í‡∂≠‡∑ä‡∂≠‡∂ª, ‡∂ö‡∑í‡∂ª‡∑í‡∂¥‡∑í‡∂ß‡∑í, ‡∂ë‡∑É‡∂±‡∑ä‡∑É‡∑ä"; ingTa="‡Æâ‡Æ≥‡Øç‡Æ≥‡Æü‡Æô‡Øç‡Æï‡Æø‡ÆØ‡Æµ‡Øà: ‡Æï‡Øã‡Æ§‡ØÅ‡ÆÆ‡Øà ‡ÆÆ‡Ææ, ‡ÆÆ‡Ææ‡Æï‡Æ∞‡Æø‡Æ©‡Øç, ‡Æ™‡Øá‡Æï‡Æø‡Æô‡Øç ‡Æ™‡Æµ‡ØÅ‡Æü‡Æ∞‡Øç, ‡ÆÆ‡ØÅ‡Æü‡Øç‡Æü‡Øà, ‡Æ™‡Ææ‡Æ≤‡Øç ‡ÆÆ‡Ææ, ‡Æé‡Æö‡Æ©‡Øç‡Æ∏‡Øç"; }
                else { ingEn="Ing: Wheat flour, margarine, salt, sugar, yeast"; ingSi="‡∂Ö‡∂©‡∂Ç‡∂ú‡∑î ‡∂Ø‡∑ä‚Äç‡∂ª‡∑Ä‡∑ä‚Äç‡∂∫: ‡∂≠‡∑í‡∂ª‡∑í‡∂ü‡∑î ‡∂¥‡∑í‡∂ß‡∑í, ‡∂∏‡∑è‡∂ú‡∂ª‡∑í‡∂±‡∑ä, ‡∂Ω‡∑î‡∂´‡∑î, ‡∑É‡∑ì‡∂±‡∑í, ‡∂ä‡∑É‡∑ä‡∂ß‡∑ä"; ingTa="‡Æâ‡Æ≥‡Øç‡Æ≥‡Æü‡Æô‡Øç‡Æï‡Æø‡ÆØ‡Æµ‡Øà: ‡Æï‡Øã‡Æ§‡ØÅ‡ÆÆ‡Øà ‡ÆÆ‡Ææ, ‡ÆÆ‡Ææ‡Æú‡Æ∞‡Æø‡Æ©‡Øç, ‡Æâ‡Æ™‡Øç‡Æ™‡ØÅ, ‡Æö‡ØÄ‡Æ©‡Æø, ‡Æà‡Æ∏‡Øç‡Æü‡Øç"; }
                
                let sFontSize = item.sinhala.length > 20 ? "8.3pt" : "12pt";
                let eFontSize, eLineHeight, eWhiteSpace;
                if(item.english.length > 20) { eFontSize="9pt"; eLineHeight="0.85"; eWhiteSpace="normal"; }
                else if(item.english.length > 15) { eFontSize="11pt"; eLineHeight="0.9"; eWhiteSpace="normal"; }
                else if(item.english.length > 12) { eFontSize="13pt"; eWhiteSpace="nowrap"; }
                else { eFontSize="15pt"; eWhiteSpace="nowrap"; }
                let lblEn = item.type==='pieces'?"Pieces":"Weight", lblSi=item.type==='pieces'?"‡∂ö‡∑ê‡∂∂‡∂Ω‡∑í ‡∂ú‡∂´‡∂±":"‡∂∂‡∂ª", lblTa=item.type==='pieces'?"‡Æé‡Æ£‡Øç‡Æ£‡Æø‡Æï‡Øç‡Æï‡Øà":"‡Æ®‡Æø‡Æ±‡Øà", displayTol=item.type==='pieces'?'none':'block';

                for(let i=0; i<item.printCount; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'sticker-slot';
                    if(guides) slot.classList.add('dashed-border');
                    const clone = master.cloneNode(true);
                    clone.id = ""; clone.style.transform = "none"; clone.style.margin = "0";

                    clone.querySelector('#out-sinhala').innerText = item.sinhala;
                    clone.querySelector('#out-sinhala').style.fontSize = sFontSize;
                    const elEng = clone.querySelector('#out-english');
                    elEng.innerText = item.english; elEng.style.fontSize = eFontSize;
                    if(eLineHeight) elEng.style.lineHeight = eLineHeight;
                    elEng.style.whiteSpace = eWhiteSpace || 'nowrap';
                    clone.querySelector('#out-mfd').innerText = item.mfd; clone.querySelector('#out-exp').innerText = item.exp;
                    clone.querySelector('#out-price').innerText = item.price; clone.querySelector('#out-weight').innerText = item.weight;
                    clone.querySelector('#out-batch').innerText = item.batch;
                    clone.querySelector('#out-ing-en').innerText = ingEn; clone.querySelector('#out-ing-si').innerText = ingSi; clone.querySelector('#out-ing-ta').innerText = ingTa;
                    clone.querySelector('#lbl-weight-en').innerText = lblEn; clone.querySelector('#lbl-weight-si').innerText = lblSi; clone.querySelector('#lbl-weight-ta').innerText = lblTa;
                    clone.querySelector('#out-tol').style.display = displayTol;

                    slot.appendChild(clone);
                    currentGrid.appendChild(slot); // Append to current grid chunk
                }
            });
            window.print();
        }

        renderProductList(); selectProduct(state.currentId); saveHistory();
    </script>
</body>
</html>